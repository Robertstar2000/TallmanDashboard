# PowerShell script to repair the complete-chart-data.ts file
# This script will:
# 1. Fix the duplicate declarations of initialSpreadsheetData
# 2. Update the POR SQL expressions to use proper MS Access/Jet SQL syntax

$filePath = "C:\Users\BobM\CascadeProjects\TallmanDashboard_new\lib\db\complete-chart-data.ts"
$backupPath = "C:\Users\BobM\CascadeProjects\TallmanDashboard_new\lib\db\complete-chart-data.ts.bak"

# Create a backup of the original file
Copy-Item -Path $filePath -Destination $backupPath
Write-Host "Created backup at $backupPath"

# Extract the first instance of the data array
$content = Get-Content -Path $filePath -Raw
$startMarker = "export const initialSpreadsheetData: SpreadsheetRow[] = ["
$endMarker = "];"

if ($content -match "$([regex]::Escape($startMarker))(.*?)$([regex]::Escape($endMarker))") {
    $jsonArrayText = $matches[1]
    Write-Host "Successfully extracted data array"
} else {
    Write-Error "Could not find the spreadsheet data in the file"
    exit 1
}

# Convert the extracted text to valid JSON by adding square brackets
$jsonText = "[$jsonArrayText]"

# Parse the JSON
try {
    $jsonArray = $jsonText | ConvertFrom-Json
    Write-Host "Successfully parsed JSON with $($jsonArray.Count) entries"
} catch {
    Write-Error "Failed to parse JSON: $_"
    exit 1
}

# Define the correct MS Access/Jet SQL syntax for each metric type
$newRentalsSql = "SELECT Count(*) as value FROM Transactions WHERE Month(DateCreated) = {0} AND Year(DateCreated) = Year(Date())"
$openRentalsSql = "SELECT Count(*) as value FROM Transactions WHERE TransactionStatus IN ('Open', 'Active', 'Out')"
$openRentalsMonthSql = "SELECT Count(*) as value FROM Transactions WHERE TransactionStatus IN ('Open', 'Active', 'Out') AND Month(DateCreated) = {0}"
$rentalValueSql = "SELECT Sum(TotalAmount) as value FROM Transactions WHERE TransactionStatus IN ('Open', 'Active', 'Out')"
$rentalValueMonthSql = "SELECT Sum(TotalAmount) as value FROM Transactions WHERE TransactionStatus IN ('Open', 'Active', 'Out') AND Month(DateCreated) = {0}"

# Define month mappings
$monthMap = @{
    "Jan" = 1; "Feb" = 2; "Mar" = 3; "Apr" = 4; "May" = 5; "Jun" = 6;
    "Jul" = 7; "Aug" = 8; "Sep" = 9; "Oct" = 10; "Nov" = 11; "Dec" = 12
}

# Update the SQL expressions for POR entries (IDs 127-174)
$porCount = 0
foreach ($item in $jsonArray) {
    # Only process POR entries
    if ($item.serverName -eq "POR") {
        $porCount++
        
        # Update tableName if it's still "Rentals"
        if ($item.tableName -eq "Rentals") {
            $item.tableName = "Transactions"
        }
        
        # Update the SQL expression based on the DataPoint
        if ($item.DataPoint -match "POR Overview New Rentals, (\w+)") {
            $month = $matches[1]
            $monthNum = $monthMap[$month]
            $item.productionSqlExpression = $newRentalsSql -f $monthNum
        }
        elseif ($item.DataPoint -match "POR Overview Open Rentals, (\w+)") {
            $month = $matches[1]
            $monthNum = $monthMap[$month]
            $item.productionSqlExpression = $openRentalsMonthSql -f $monthNum
        }
        elseif ($item.DataPoint -eq "POR Overview Open Rentals") {
            $item.productionSqlExpression = $openRentalsSql
        }
        elseif ($item.DataPoint -match "POR Overview Rental Value, (\w+)") {
            $month = $matches[1]
            $monthNum = $monthMap[$month]
            $item.productionSqlExpression = $rentalValueMonthSql -f $monthNum
        }
        elseif ($item.DataPoint -eq "POR Overview Rental Value") {
            $item.productionSqlExpression = $rentalValueSql
        }
        
        # Update the lastUpdated timestamp
        $item.lastUpdated = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
    }
}

Write-Host "Updated $porCount POR entries"

# Convert back to JSON with proper formatting
$updatedJsonArrayText = $jsonArray | ConvertTo-Json -Depth 10

# Remove the outer square brackets
$updatedJsonArrayText = $updatedJsonArrayText.Substring(1, $updatedJsonArrayText.Length - 2)

# Create the new file content
$newFileContent = @"
import type { SpreadsheetRow } from './types';

// This file was auto-generated by the generate-complete-chart-data.js script
// Last updated: $(Get-Date -Format "yyyy-MM-ddTHH:mm:ss.fffZ")

export const initialSpreadsheetData: SpreadsheetRow[] = [$updatedJsonArrayText
];

// Export the combined data
export const combinedData = [...initialSpreadsheetData];
"@

# Write the updated content to the file
Set-Content -Path $filePath -Value $newFileContent

Write-Host "File repaired and POR SQL expressions updated with correct MS Access/Jet SQL syntax!"
